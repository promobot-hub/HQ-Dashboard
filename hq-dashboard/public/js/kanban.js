// copied from frontend/js/kanban.js
(function(){
  const POLL_MS = 5000;
  const API_TASKS = '/api/tasks';
  const API_TASK_LOG = (id)=> `/api/task/${encodeURIComponent(id)}/logs`;
  const state = { tasks: [], mounted: false, filter: 'all', query: '', mute: true };
  const MAX_CONCURRENT = 2; let active = 0; const queue = [];
  function limitedFetch(url, init){ return new Promise((resolve, reject)=>{ const run=()=>{ active++; fetch(url, init).then(resolve, reject).finally(()=>{ active--; const n=queue.shift(); n&&n(); }); }; if (active<MAX_CONCURRENT) run(); else queue.push(run); }); }
  function qs(s,r=document){ return r.querySelector(s);} function qsa(s,r=document){ return Array.from(r.querySelectorAll(s)); }
  function ensureContainer(){ let cont=qs('#kanban-container'); if(!cont){ const host=qs('#content')||document.body; const sec=document.createElement('section'); sec.className='mt-6'; sec.innerHTML='<div id="kanban-container" class="grid grid-cols-12 gap-4" aria-live="polite"></div>'; host.appendChild(sec); cont=qs('#kanban-container'); } return cont; }
  function spinner(){ const d=document.createElement('div'); d.className='flex items-center justify-center py-6'; d.innerHTML='<div class="claw-spinner" style="width:42px;height:42px;border-radius:9999px;border:3px solid rgba(255,255,255,0.08);border-top-color:#22d3ee;border-right-color:#a855f7;animation: claw-spin 1s linear infinite;box-shadow: inset 0 0 12px rgba(168,85,247,0.2)"></div>'; const style=document.createElement('style'); style.textContent='@keyframes claw-spin{to{transform:rotate(360deg)}}'; document.head.appendChild(style); return d; }
  function badge(k){ if(k==='pending')return'<span class="rounded-md bg-white/10 px-1.5 py-0.5 text-[10px] text-white/70">Pending</span>'; if(k==='progress')return'<span class="rounded-md bg-accent-cyan/20 px-1.5 py-0.5 text-[10px] text-accent-cyan">In Progress</span>'; return'<span class="rounded-md bg-emerald-400/20 px-1.5 py-0.5 text-[10px] text-emerald-400">Done</span>'; }
  function colHeader(k){ const c=k==='pending'?'text-white/60':(k==='progress'?'text-accent-cyan':'text-emerald-400'); const t=k==='pending'?'Pending Tasks':(k==='progress'?'In Progress':'Done'); return `<div class="mb-2 flex items-center justify-between"><div class="text-xs uppercase tracking-wide ${c}">${t}</div><div class="text-[11px] text-white/50" data-count="${k}"></div></div>`; }
  function ensureColumns(){ const cont=ensureContainer(); if(!state.mounted){ cont.addEventListener('dragover',(e)=>{ e.preventDefault(); const col=e.target.closest('[data-list]'); if(col) col.classList.add('outline','outline-1','outline-accent-cyan/30');}); cont.addEventListener('dragleave',(e)=>{ const col=e.target.closest('[data-list]'); if(col) col.classList.remove('outline','outline-1','outline-accent-cyan/30');}); cont.addEventListener('drop',(e)=>{ e.preventDefault(); qsa('[data-list]').forEach(c=>c.classList.remove('outline','outline-1','outline-accent-cyan/30')); const wrap=e.target.closest('[data-col]'); if(!wrap)return; const target=wrap.getAttribute('data-col'); const id=e.dataTransfer?.getData('text/plain'); if(!id||!target) return; state.tasks=state.tasks.map(x=> x.id===id?{...x,status:target}:x); mountTasks(applyFilters(state.tasks)); }); cont.innerHTML=['pending','progress','done'].map(k=>`<section class="col-span-12 md:col-span-4"><div class="rounded-2xl border ${k==='pending'?'border-white/10':(k==='progress'?'border-accent-cyan/30':'border-emerald-400/30')} ${k==='pending'?'bg-white/5':(k==='progress'?'bg-accent-cyan/10':'bg-emerald-400/10')} backdrop-blur-md shadow-[0_8px_32px_rgba(0,0,0,0.35)] p-4" data-col="${k}">${colHeader(k)}<div class="space-y-2" data-list="${k}"></div></div></section>`).join(''); state.mounted=true;} return cont; }
  function cardEl(t){ const pct=Math.max(0,Math.min(100,Number(t.progress||0))); const pulse=t.status==='progress'?' ring-1 ring-accent-cyan/30':''; const done=t.status==='done'?' ring-1 ring-emerald-400/30':''; const el=document.createElement('div'); el.className=`rounded-xl border border-white/10 bg-white/5 p-3 text-sm text-white/90 hover:bg-white/10 transition-all duration-200 translate-y-0 opacity-100${pulse}${done}`; el.dataset.taskId=t.id; el.setAttribute('role','button'); el.setAttribute('tabindex','0'); el.setAttribute('aria-label',`Task ${t.id}: ${t.title} (${t.status})`); el.draggable=true; el.addEventListener('dragstart',(ev)=>{ ev.dataTransfer?.setData('text/plain', t.id); const g=document.createElement('div'); g.className='rounded-lg px-2 py-1 bg-white/10 text-white/80 text-xs'; g.textContent=t.title; document.body.appendChild(g); ev.dataTransfer?.setDragImage(g,0,0); setTimeout(()=>g.remove(),0); autoScrollStart();}); el.addEventListener('dragend',()=> autoScrollStop()); el.addEventListener('dblclick',()=> openExtendedLog(t)); el.innerHTML=`<div class="flex items-center justify-between gap-2"><div class="font-semibold truncate">${t.id} — ${t.title}</div>${badge(t.status)}</div><div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/10"><div class="h-full bg-gradient-to-r from-accent-cyan to-accent-violet" style="width:${pct}%"></div></div><div class="mt-2 flex items-center justify-between text-[11px] text-white/60"><span>${new Date(t.updated_at||t.created_at||Date.now()).toLocaleString()}</span><button class="rounded-lg border border-white/10 bg-white/5 px-2 py-0.5 text-[11px] hover:bg-white/10" data-view-log>View Log</button></div>`; el.querySelector('[data-view-log]')?.addEventListener('click',()=> openLogModal(t.id)); return el; }
  function updateCounts(){ const c={pending:0,progress:0,done:0}; state.tasks.forEach(t=> c[t.status]=(c[t.status]||0)+1); qsa('[data-count]').forEach(n=>{ const k=n.getAttribute('data-count'); if(k&&c[k]!=null) n.textContent=`${c[k]} items`; }); }
  function applyFilters(tasks){ const q=state.query.trim().toLowerCase(); return tasks.filter(t=> (state.filter==='all'||t.status===state.filter) && (!q || (t.title||'').toLowerCase().includes(q) || String(t.id).toLowerCase().includes(q))); }
  function mountTasks(tasks){ ensureColumns(); const lists={ pending:qs('[data-list="pending"]'), progress:qs('[data-list="progress"]'), done:qs('[data-list="done"]') }; const existing=new Map(); qsa('[data-list] > div').forEach(el=> existing.set(el.dataset.taskId, el)); const seen=new Set(); tasks.forEach(t=>{ seen.add(t.id); const want=lists[t.status]; const cur=existing.get(t.id); if(!cur){ const el=cardEl(t); el.style.opacity='0'; el.style.transform='translateY(6px)'; want.appendChild(el); requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; }); } else { const bar=cur.querySelector('div > div > div'); if(bar) (bar as HTMLElement).style.width=`${Math.max(0,Math.min(100,Number(t.progress||0)))}%`; if(cur.parentElement!==want){ cur.style.opacity='0.0'; cur.style.transform='translateY(6px)'; setTimeout(()=>{ want.appendChild(cur); requestAnimationFrame(()=>{ cur.style.opacity='1'; cur.style.transform='translateY(0)'; }); if(t.status==='done') confetti(cur); },120); } } }); existing.forEach((el,id)=>{ if(!seen.has(id)){ el.style.opacity='0'; el.style.transform='translateY(6px)'; setTimeout(()=> el.remove(),150); } }); state.tasks=tasks; updateCounts(); }
  function confetti(target){ const host=document.createElement('div'); const rect=target.getBoundingClientRect(); Object.assign(host.style,{position:'fixed',left:rect.left+'px',top:(rect.top-8)+'px',width:rect.width+'px',height:'0px',pointerEvents:'none',zIndex:'70'}); for(let i=0;i<20;i++){ const p=document.createElement('span'); const size=4+Math.random()*4; Object.assign(p.style,{position:'absolute',left:(rect.width/2)+'px',top:'0px',width:size+'px',height:size+'px',borderRadius:'1px',background: i%2?'#22d3ee':'#a855f7'}); const dx=(Math.random()-0.5)*120, dy=40+Math.random()*60, rot=(Math.random()-0.5)*180; p.animate([{transform:'translate(0,0) rotate(0deg)',opacity:1},{transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg)`,opacity:0}],{duration:700+Math.random()*400,easing:'cubic-bezier(.2,.8,.2,1)',fill:'forwards'}); host.appendChild(p);} document.body.appendChild(host); setTimeout(()=> host.remove(),1200); }
  async function fetchTasks(){ try{ const r=await limitedFetch(API_TASKS,{cache:'no-store'}); if(!r.ok) throw new Error('bad'); const data=await r.json(); const tasks=(data.tasks||[]).map(t=>({ id:String(t.id||t.title||Math.random().toString(36).slice(2,8)), title:t.title||t.text||'Task', status:(t.status==='todo'?'pending':(t.status==='in_progress'?'progress':(t.status||'done'))), progress:Number(t.progress||(t.status==='done'?100:(t.status==='in_progress'?50:10))), created_at:t.created_at||new Date().toISOString(), updated_at:t.updated_at||new Date().toISOString(), log_link:t.log_link||'#'})); return tasks;}catch(e){ const now=new Date().toISOString(); return[{id:'F-201',title:'Fallback pending',status:'pending',progress:10,created_at:now,updated_at:now,log_link:'#'},{id:'F-202',title:'Fallback in progress',status:'progress',progress:55,created_at:now,updated_at:now,log_link:'#'},{id:'F-203',title:'Fallback done',status:'done',progress:100,created_at:now,updated_at:now,log_link:'#'}]; } }
  async function openLogModal(taskId){ const m=(window as any).ClawModals?.createModal? (window as any).ClawModals.createModal({ title:`Task ${taskId} – Log`, content:'<div class="text-white/70 text-sm">Loading log...</div>', actions:[{label:'Close'}] }) : null; try{ const r=await limitedFetch(`/api/task/${encodeURIComponent(taskId)}/logs`,{cache:'no-store'}); if(!r.ok) throw new Error('x'); const text=await r.text(); if(m) m.body.innerHTML=`<pre class="text-xs whitespace-pre-wrap text-white/80">${text.replace(/[&<>]/g,(s)=>({'&':'&amp;','<':'&lt;','>':'&gt;'} as any)[s])}</pre>`; else alert(text);}catch{ const fallback=`No server log endpoint; showing placeholder for ${taskId}.\n\n- Heartbeat: ok\n- AutoImprove: last run success\n- Actions: commit, push, deploy`; if(m) m.body.innerHTML=`<pre class="text-xs whitespace-pre-wrap text-white/70">${fallback}</pre>`; else alert(fallback);} }
  function wireControls(){ qsa('[data-filter]').forEach(btn=>{ btn.addEventListener('click', ()=>{ qsa('[data-filter]').forEach(b=> b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); state.filter=btn.getAttribute('data-filter')||'all'; tick(false); });}); const search=qs('#kanbanSearch'); if(search){ let to=null; search.addEventListener('input',()=>{ clearTimeout(to); to=setTimeout(()=>{ state.query=search.value||''; tick(false); },150);}); } const snd=qs('#soundToggle'); snd?.addEventListener('click',()=>{ state.mute=!state.mute; (snd as HTMLButtonElement).textContent='Sound: '+(state.mute?'Off':'On'); snd.setAttribute('aria-pressed', (!state.mute).toString()); }); document.addEventListener('keydown',(e)=>{ if(e.key==='f'||e.key==='F'){ e.preventDefault(); qs('#kanbanSearch')?.focus(); } if(e.key==='1'){ state.filter='all'; tick(false);} if(e.key==='2'){ state.filter='pending'; tick(false);} if(e.key==='3'){ state.filter='progress'; tick(false);} if(e.key==='4'){ state.filter='done'; tick(false);} if(e.key==='r'||e.key==='R'){ tick(false);} if(e.key==='m'||e.key==='M'){ (qs('#soundToggle') as HTMLButtonElement)?.click(); } }); }
  let scrollTimer=null; function autoScrollStart(){ if(scrollTimer) return; scrollTimer=setInterval(()=>{ const y=window.scrollY; const vh=window.innerHeight; const mx=20; const p=(window as any).event; const cy=p&&p.clientY? p.clientY:null; if(cy!=null){ if(cy>vh-mx) window.scrollTo({top:y+20,behavior:'auto'}); else if(cy<mx) window.scrollTo({top:Math.max(0,y-20),behavior:'auto'});} },50);} function autoScrollStop(){ if(scrollTimer){ clearInterval(scrollTimer); scrollTimer=null; } }
  async function tick(first=false){ const cont=ensureColumns(); if(first){ cont.innerHTML = cont.innerHTML + spinner().outerHTML; } const tasks=await fetchTasks(); mountTasks(applyFilters(tasks)); }
  document.addEventListener('DOMContentLoaded', ()=>{ wireControls(); tick(true); setInterval(()=>{ tick(false); }, POLL_MS); });
})();
