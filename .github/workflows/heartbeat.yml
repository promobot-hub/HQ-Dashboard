name: Heartbeat Micro-Commit

on:
  # schedule temporarily paused for merge window
  # - cron: '*/10 * * * *'  # every 10 minutes
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: heartbeat-${{ github.ref }}
  cancel-in-progress: true

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run heartbeat updates (no install needed)
        run: |
          node scripts/repoHygiene.js || true
          node scripts/incrementRunCounters.js || true
          node scripts/updateHeartbeatState.js || true
          node scripts/updateStatusAndLog.js || true
          node scripts/checkRenderInbox.js || true
          node scripts/updateTaskLedger.js || true

      - name: (optional) format hq-dashboard with Prettier
        run: |
          npx --yes prettier@2.8.8 --write "hq-dashboard/**/*.{js,jsx,ts,tsx,css,md,json}" || true

      - name: Update README badges (optional)
        run: |
          node -e "const fs=require('fs'); let r=fs.readFileSync('README.md','utf8'); const s=require('./heartbeat-state.json'); const runs=s.runsToday||0, total=s.totalRuns||0; r=r.replace(/runs_today-[0-9]+-blue/, 'runs_today-'+runs+'-blue').replace(/total_runs-[0-9]+-blue/,'total_runs-'+total+'-blue'); fs.writeFileSync('README.md', r)" || true

      - name: Sync hq-dashboard subtree (paused)
        if: ${{ false }}
        run: |
          echo "paused during merge window"

      - name: Commit if changes (paused)
        if: ${{ false }}
        run: |
          echo "paused during merge window"

      - name: Push (paused)
        if: ${{ false }}
        run: |
          echo "paused during merge window"
